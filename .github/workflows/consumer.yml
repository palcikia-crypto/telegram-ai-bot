name: Consumer

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # каждые 5 минут

jobs:
  consumer-job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install requests
        run: pip install requests
      - name: Run processor
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 - <<EOF
import json, os, requests, time

QUEUE_FILE = "state/queue.json"

if not os.path.exists(QUEUE_FILE):
    with open(QUEUE_FILE, "w") as f:
        json.dump([], f)

with open(QUEUE_FILE, "r") as f:
    tasks = json.load(f)

updated = False
for task in tasks:
    if not task.get("processed"):
        # OpenRouter API
        try:
            resp = requests.post(
                "https://openrouter.ai/api/v1/chat/completions",
                headers={
                    "Authorization": f"Bearer {os.getenv('OPENROUTER_API_KEY')}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": "openai/gpt-3.5-turbo",
                    "messages": [{"role": "user", "content": task["prompt"]}]
                }
            )
            data = resp.json()
            result = data["choices"][0]["message"]["content"]
        except:
            continue

        # Telegram
        try:
            requests.post(
                f"https://api.telegram.org/bot{os.getenv('TELEGRAM_TOKEN')}/sendMessage",
                json={"chat_id": os.getenv("TELEGRAM_CHAT_ID"), "text": result}
            )
        except:
            pass

        task["processed"] = True
        updated = True

if updated:
    with open(QUEUE_FILE, "w") as f:
        json.dump(tasks, f, indent=2)
EOF
      - name: Commit updated queue
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state/queue.json
          git commit -m "Update queue" || echo "No changes"
          git push
